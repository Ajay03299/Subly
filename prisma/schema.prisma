// Subscription Management System — Prisma Schema
// https://pris.ly/d/prisma-schema

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// ─────────────────────────────────────────────────────────
//  Enums
// ─────────────────────────────────────────────────────────

enum Role {
  ADMIN
  INTERNAL_USER
  USER
}

// Product Type follows the Odoo convention:
//   SERVICE    — intangible, delivered as a service (SaaS plans, support, etc.)
//   CONSUMABLE — physical goods with no inventory tracking
//   STORABLE   — physical goods tracked in inventory
enum ProductType {
  SERVICE
  CONSUMABLE
  STORABLE
}

enum BillingPeriod {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  DRAFT
  QUOTATION
  CONFIRMED
  ACTIVE
  CLOSED
}

enum InvoiceStatus {
  DRAFT
  CONFIRMED
  PAID
  CANCELLED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  UPI
  CASH
  OTHER
}

enum DiscountType {
  FIXED
  PERCENTAGE
}

// ─────────────────────────────────────────────────────────
//  User
// ─────────────────────────────────────────────────────────

model User {
  id         String    @id @default(cuid())
  email      String    @unique
  password   String // bcrypt hash
  verifiedAt DateTime?
  role       Role      @default(USER)

  subscriptions Subscription[]
  payments      Payment[]
  refreshTokens RefreshToken[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@map("refresh_tokens")
}

// ─────────────────────────────────────────────────────────
//  Product & Variants
// ─────────────────────────────────────────────────────────

model Product {
  id            String      @id @default(cuid())
  name          String
  description   String? // Product description
  type          ProductType @default(SERVICE)
  salesPrice    Decimal     @db.Decimal(10, 2)
  costPrice     Decimal     @db.Decimal(10, 2)
  tagId         String?
  taxId         String? // Tax bracket this product belongs to
  averageRating Decimal     @default(0) @db.Decimal(3, 2) // 0-5 rating

  variants               Variant[]
  tag                    ProductTag?             @relation(fields: [tagId], references: [id])
  tax                    Tax?                    @relation(fields: [taxId], references: [id])
  images                 ProductImage[]
  recurringPlans         RecurringPlan[]
  subscriptionLines      SubscriptionLine[]
  invoiceLines           InvoiceLine[]
  quotationTemplateLines QuotationTemplateLine[]
  discounts              Discount[] // many-to-many implicit

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("products")
}

model ProductTag {
  id       String    @id @default(cuid())
  name     String    @unique
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product_tags")
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String // Image URL
  alt       String? // Alt text for accessibility

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@map("product_images")
}

model Variant {
  id         String  @id @default(cuid())
  productId  String
  product    Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  attribute  String // e.g. "Brand", "Tier", "Region"
  value      String // e.g. "Odoo", "Enterprise", "US"
  extraPrice Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@map("variants")
}

// ─────────────────────────────────────────────────────────
//  Recurring Plan
// ─────────────────────────────────────────────────────────

model RecurringPlan {
  id              String        @id @default(cuid())
  productId       String
  product         Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  name            String
  price           Decimal       @db.Decimal(10, 2)
  billingPeriod   BillingPeriod
  minimumQuantity Int           @default(1)
  startDate       DateTime
  endDate         DateTime?

  // Plan options
  autoClose Boolean @default(false)
  closeable Boolean @default(true)
  renewable Boolean @default(true)
  pausable  Boolean @default(false)

  subscriptions      Subscription[]
  quotationTemplates QuotationTemplate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@map("recurring_plans")
}

// ─────────────────────────────────────────────────────────
//  Subscription & Order Lines
// ─────────────────────────────────────────────────────────

model Subscription {
  id             String @id @default(cuid())
  subscriptionNo String @unique @default(cuid()) // human-friendly number set by app logic

  userId String
  user   User   @relation(fields: [userId], references: [id])

  recurringPlanId String?
  recurringPlan   RecurringPlan? @relation(fields: [recurringPlanId], references: [id])

  paymentTerms String? // e.g. "Net 30", "Due on Receipt"

  status SubscriptionStatus @default(DRAFT)

  // Discount information
  discountCode   String? // the code applied, if any
  discountAmount Decimal @default(0) @db.Decimal(12, 2) // amount discounted

  // Computed totals — kept in sync by application logic
  subtotal    Decimal @default(0) @db.Decimal(12, 2)
  taxAmount   Decimal @default(0) @db.Decimal(12, 2)
  totalAmount Decimal @default(0) @db.Decimal(12, 2)

  lines    SubscriptionLine[]
  invoices Invoice[]
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

/// One line item per product in a subscription (Order Lines).
/// amount = quantity * unitPrice * (1 + taxRate / 100)
model SubscriptionLine {
  id String @id @default(cuid())

  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  taxId String?
  tax   Tax?    @relation(fields: [taxId], references: [id])

  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2) // price after any discount
  taxRate   Decimal @default(0) @db.Decimal(5, 2) // percentage, e.g. 18.00
  amount    Decimal @db.Decimal(12, 2) // computed: qty * unitPrice inclusive of tax

  // Reviews
  rating Int? // 1 to 5

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([productId])
  @@map("subscription_lines")
}

//  Quotation Templates (predefined setups for quick sub creation)
// ─────────────────────────────────────────────────────────

model QuotationTemplate {
  id           String @id @default(cuid())
  name         String
  validityDays Int    @default(30)

  recurringPlanId String?
  recurringPlan   RecurringPlan? @relation(fields: [recurringPlanId], references: [id])

  lines QuotationTemplateLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("quotation_templates")
}

model QuotationTemplateLine {
  id String @id @default(cuid())

  templateId String
  template   QuotationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([templateId])
  @@map("quotation_template_lines")
}

// ─────────────────────────────────────────────────────────
//  Tax  (configurable — default rate loaded from env at app layer)
// ─────────────────────────────────────────────────────────

model Tax {
  id                String             @id @default(cuid())
  name              String // e.g. "GST 18%", "VAT 20%"
  rate              Decimal            @db.Decimal(5, 2) // percentage value
  isDefault         Boolean            @default(false) // if true, auto-applied to new lines
  products          Product[]
  subscriptionLines SubscriptionLine[]

  invoiceLines InvoiceLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("taxes")
}

// ─────────────────────────────────────────────────────────
//  Invoice  (expand later — structure ready)
// ─────────────────────────────────────────────────────────

model Invoice {
  id        String @id @default(cuid())
  invoiceNo String @unique @default(cuid())

  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  status    InvoiceStatus @default(DRAFT)
  issueDate DateTime      @default(now())
  dueDate   DateTime?

  subtotal    Decimal @default(0) @db.Decimal(12, 2)
  taxAmount   Decimal @default(0) @db.Decimal(12, 2)
  totalAmount Decimal @default(0) @db.Decimal(12, 2)

  lines    InvoiceLine[]
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([status])
  @@map("invoices")
}

model InvoiceLine {
  id String @id @default(cuid())

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  taxId String?
  tax   Tax?    @relation(fields: [taxId], references: [id])

  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  taxAmount Decimal @default(0) @db.Decimal(10, 2)
  amount    Decimal @db.Decimal(12, 2) // line total

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@map("invoice_lines")
}

// ─────────────────────────────────────────────────────────
//  Payment
// ─────────────────────────────────────────────────────────

model Payment {
  id          String        @id @default(cuid())
  method      PaymentMethod
  amount      Decimal       @db.Decimal(12, 2)
  paymentDate DateTime      @default(now())

  // Linked to the subscription (one-time or recurring)
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id])

  // Optionally tied to a specific invoice
  invoiceId String?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([userId])
  @@map("payments")
}

// ─────────────────────────────────────────────────────────
//  Discount  (expand later — structure ready)
// ─────────────────────────────────────────────────────────

model Discount {
  id              String       @id @default(cuid())
  name            String
  code            String       @unique
  type            DiscountType
  value           Decimal      @db.Decimal(10, 2) // fixed amount or percentage
  minimumPurchase Decimal      @default(0) @db.Decimal(10, 2)
  minimumQuantity Int          @default(0)
  startDate       DateTime
  endDate         DateTime?
  limitUsage      Int? // null = unlimited

  // Many-to-many: which products this discount applies to
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("discounts")
}
